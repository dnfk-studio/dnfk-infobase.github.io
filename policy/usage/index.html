<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <script>
    (function() {
      function forceMaintenanceRedirect() {
        console.warn("系統偵測到異常，強制進入維護模式");
        if (!location.pathname.includes("/maintenance")) {
          location.replace("/maintenance?v=" + Date.now());
        }
      }


      function ensureBootLoading() {
        if (document.getElementById('dnfk-boot-loading')) return;
        if (!document.getElementById('dnfk-boot-loading-style')) {
          var st = document.createElement('style');
          st.id = 'dnfk-boot-loading-style';
          st.textContent =
            "html.dnfk-boot-lock, html.dnfk-boot-lock body{overflow:hidden}" +
            "#dnfk-boot-loading{position:fixed;inset:0;z-index:99999;display:flex;align-items:center;justify-content:center;" +
            "background:rgba(0,0,0,.55);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px)}" +
            "#dnfk-boot-loading .spinner{width:42px;height:42px;border-radius:50%;border:3px solid rgba(255,255,255,.25);" +
            "border-top-color:rgba(255,255,255,.85);animation:dnfkSpin .9s linear infinite}" +
            "@keyframes dnfkSpin{to{transform:rotate(360deg)}}";
          document.head.appendChild(st);
        }
        var ov = document.createElement('div');
        ov.id = 'dnfk-boot-loading';
        ov.setAttribute('role', 'status');
        ov.setAttribute('aria-live', 'polite');
        ov.innerHTML = "<div class='spinner' aria-label='Loading'></div>";
        document.documentElement.appendChild(ov);
        document.documentElement.classList.add('dnfk-boot-lock');
      }

      function removeBootLoading() {
        var ov = document.getElementById('dnfk-boot-loading');
        if (ov) ov.remove();
        document.documentElement.classList.remove('dnfk-boot-lock');
      }

      ensureBootLoading();

      var cfg = document.createElement('script');
      var apiUrl = "/api/data/config.js";
      cfg.src = apiUrl + "?v=" + Date.now();
      
      cfg.onload = function() {
        try {
          console.log("維護模式狀態:", window.__DNFK_MAINTENANCE__);
          if (typeof window.__DNFK_MAINTENANCE__ === 'undefined') {
              throw new Error("Config not loaded properly");
          }

          if (window.__DNFK_MAINTENANCE__) {
            if (!location.pathname.includes("/maintenance")) {
              location.replace("/maintenance?v=" + Date.now());
              return;
            }
            // 已在維護頁面：解除遮罩，允許閱讀
            removeBootLoading();
          } else {
            removeBootLoading();
          }
        } catch (e) {
          console.error("檢查維護模式時發生錯誤", e);
          forceMaintenanceRedirect();
        }
      };
      
      cfg.onerror = function() {
          console.error("讀取維護設定失敗 (Network Error)");
          forceMaintenanceRedirect();
      };
      
      document.head.appendChild(cfg);
    })();
  </script>
  
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>使用條款｜DNFK Info-Base</title>
    <style>
        body {
            font-family: "Helvetica Neue", Helvetica, Arial, "PingFang TC", "Microsoft JhengHei", sans-serif;
            line-height: 1.8;
            color: #333;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
        }

        .container {
            max-width: 800px;
            margin: 40px auto;
            background: #fff;
            padding: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-radius: 8px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .page-title {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
        }

        .btn-home {
            display: inline-block;
            text-decoration: none;
            background-color: #333;
            color: #fff;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn-home:hover {
            background-color: #555;
        }

        .policy-section {
            margin-bottom: 40px;
        }

        .policy-section h2 {
            font-size: 18px;
            border-left: 4px solid #333;
            padding-left: 10px;
            margin-bottom: 15px;
            background-color: #f4f4f4;
            padding: 8px 10px;
        }

        .policy-section p {
            margin-bottom: 15px;
            text-align: justify;
        }

        .policy-section ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }

        .policy-section li {
            margin-bottom: 8px;
        }

        .footer {
            margin-top: 60px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #888;
            font-size: 14px;
        }

        @media (max-width: 600px) {
            .container {
                margin: 0;
                border-radius: 0;
                padding: 20px;
            }
            .page-header {
                flex-direction: column-reverse;
                align-items: flex-start;
                gap: 15px;
            }
        }
        </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">使用條款</h1>
            <a class="btn-home" href="/">回到首頁</a>
        </div>

        <div id="policyRoot">
            <div class="policy-section">
                <h2>載入中</h2>
                <p>資料載入中…</p>
            </div>
        </div>
    </div>

    <script type="module">
      import { showLoading, hideLoading } from "/assets/js/app.js";

      function esc(s){
        return String(s ?? "")
          .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
          .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
      }

      function renderPolicy(data){
        const root = document.getElementById("policyRoot");
        if(!root) return;
        const foreword = data?.foreword ? `
          <div class="policy-section">
            <h2>前言</h2>
            <p>${esc(data.foreword)}</p>
          </div>` : "";

        const articles = (data?.articles || []).map(a=>{
          const contents = (a?.contents || []).map(c=>{
            const p = c?.content ? `<p>${esc(c.content)}</p>` : "";
            const ul = Array.isArray(c?.ul) && c.ul.length
              ? `<ul>${c.ul.map(x=>`<li>${esc(x.li)}</li>`).join("")}</ul>`
              : "";
            return p + ul;
          }).join("");
          return `
            <div class="policy-section">
              <h2>${esc(a?.title || "")}</h2>
              ${contents}
            </div>
          `;
        }).join("");

        root.innerHTML = foreword + articles;
      }

      async function main(){
        showLoading("資料載入中…");
        try{
          const res = await fetch("/api/data/usage.json", {cache:"no-store"});
          if(!res.ok) throw new Error("載入失敗");
          const data = await res.json();
          renderPolicy(data);
        }catch(e){
          try{ location.replace("/maintenance?v=" + Date.now()); }catch(_){}
        }finally{
          hideLoading();
        }
      }
      main();
    </script>
</body>
</html>
